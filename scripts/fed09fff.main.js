console.log("Welcome to Lostland Journey!");var journey=journey||{};journey.lastfm=function(){var a="//ws.audioscrobbler.com/2.0/",b="bd286e68d3aa369779ff55dfe15470b6",c=function(c,d,e,g){function h(d){for(var e=[],h=1;d>=h;h++){var l=$.ajax({url:a+"?method=user.getrecenttracks&user="+c+"&api_key="+b+"&limit=200&format=json&from="+i+"&to="+j+"&page="+h,success:function(a){if(a.error)console.log("ERROR [data.getLastfmTracks]:"+a.message),f();else{var b=parseInt(a.recenttracks["@attr"].page);console.log("Done page: "+b),k=k.concat(a.recenttracks.track)}}});e.push(l)}$.when.apply(null,e).done(function(){console.log("all data done!!"),g&&g(k)})}console.log("getting "+c+"'s tracks!");var i=d.getTime()/1e3,j=e.getTime()/1e3,k=[];$.ajax({url:a+"?method=user.getrecenttracks&user="+c+"&api_key="+b+"&limit=200&format=json&from="+i+"&to="+j,success:function(a){if(a.error)console.log("ERROR [data.getLastfmTracks]:"+a.message),f();else{var b=parseInt(a.recenttracks["@attr"].totalPages);console.log("Total Page: "+b),k=k.concat(a.recenttracks.track),h(b)}}})},d=function(c,d,e){console.log("getting "+c+"'s tracks by "+d+"!"),$.ajax({url:a+"?method=user.getArtistTracks&user="+c+"&artist="+d+"&api_key="+b+"&format=json",success:function(a){a.error?(console.log("ERROR [data.getLastfmArtistTracks]:"+a.message),f()):(console.log(a),e&&e(a))}})},e=function(c,d){console.log("getting "+c+"'s info!"),$.ajax({url:a+"?method=user.getInfo&user="+c+"&api_key="+b+"&format=json",success:function(a){a.error?(console.log("ERROR [data.getLastfmUserInfo]:"+a.message),f()):(console.log(a),d&&d(a))}})},f=function(){$(".overlay").hide(),$(".error").show()};return{getLastfmTracks:c,getLastfmArtistTracks:d,getLastfmUserInfo:e,handleError:f}}(),journey.data=function(){var a={totalPlays:0,averagePlays:0},b=function(a){var b={};return a.forEach(function(a){var c=new Date(1e3*parseInt(a.date.uts));console.log(a.date["#text"]);var d=c.getFullYear()+" "+c.getMonth()+" "+c.getDate();b.hasOwnProperty(d)?b[d]+=1:b[d]=1}),b},c=function(b){var c={};return b.forEach(function(b){var d=b.artist["#text"];if(b.date){var e=new Date(1e3*parseInt(b.date.uts)),f=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate();c.hasOwnProperty(f)||(c[f]={}),c[f].hasOwnProperty(d)||(c[f][d]=0),c[f][d]+=1,a.totalPlays+=1}}),a.averagePlays=a.totalPlays/Object.keys(c).length,console.log(a),c},d=function(){return a},e=function(a){var b={};return a.forEach(function(a){var c=a.artist["#text"];if(b.hasOwnProperty(c)||(b[c]={},b[c].total=0),a.date){var d=new Date(1e3*parseInt(a.date.uts)),e=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();b[c].hasOwnProperty(e)?b[c][e]+=1:b[c][e]=1,b[c].total+=1}}),b},f=function(a){var b=[];for(var c in a)if(a.hasOwnProperty(c)){var d=[];for(artistName in a[c])a[c].hasOwnProperty(artistName)&&d.push({artist:artistName,date:c,count:a[c][artistName]});d.sort(function(a,b){return a.count>b.count?-1:a.count<b.count?1:0}),b.push({date:c,artists:d})}return b},g=function(a){var b=[];for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];for(var e in d)d.hasOwnProperty(e)&&"total"!==e&&b.push({artist:c,date:e,count:d[e]})}return b};return{computeDateArtistCounts:c,getAggregateData:d,normalizeAndSort:f,computeArtistDailyCounts:b,computeDailyCounts:e,normalizeDailyCounts:g}}(),journey.artist=function(){var a={},b={},c=function(c){c.forEach(function(c){var d=c.artist["#text"];a.hasOwnProperty(d)?a[d].total++:a[d]={albums:[],topTracks:[],total:1};var e=!1;a[d].albums.forEach(function(a){a.name===c.album["#text"]&&(e=!0,a.count++)}),e||a[d].albums.push({name:c.album["#text"],image:c.image[c.image.length-1]["#text"],count:1});var f=!1;a[d].topTracks.forEach(function(a){a.name===c.name&&a.album===c.album["#text"]&&(f=!0,a.count++)}),f||a[d].topTracks.push({name:c.name,album:c.album["#text"],count:1});var g=c.name+" - "+c.album["#text"];b.hasOwnProperty(g)?b[g].count++:b[g]={name:c.name,album:c.album["#text"],artist:c.artist["#text"],count:1}});for(var d in a)a.hasOwnProperty(d)&&a[d].topTracks.sort(function(a,b){return a.count>b.count?-1:a.count<b.count?1:0})},d=function(b){return a.hasOwnProperty(b)?a[b]:null},e=function(){return a},f=function(){return b},g=function(){console.log(a)},h=function(){a={},b={}};return{computeArtistStats:c,getArtistInfo:d,printAllStats:g,clearAllStats:h,getAllArtistInfo:e,getAllTracksInfo:f}}(),journey.vis=function(){var a,b=function(b,c){function d(a,b){return.4*o>b?3:.4*-b}var e=this,f=d3.time.format("%Y-%m-%d").parse;b.forEach(function(a){a.date=f(a.date)});var g=32,h={top:0,left:g,right:g,bottom:0},i=c-h.left-h.right,j=300-h.top-h.bottom,k=d3.scale.category20(),l=d3.time.scale().range([0,i]),m=d3.scale.linear().range([j,0]),n=d3.scale.linear().range([0,g]);a=d3.select(".musicVis").append("svg").attr("width",c).attr("height",j+h.top+h.bottom).append("g").attr("transform","translate("+h.left+","+h.top+")"),l.domain(d3.extent(b,function(a){return a.date}));var o=d3.max(b,function(a){return d3.max(a.artists,function(a){return a.count})});n.domain([0,o]),console.log("maxCount: "+o),b.forEach(function(a){var b=a.artists;b.forEach(function(a,c){if(0===c)return void(a.offset=0);var e=0,f=0,g=0;return c%2===0?(e=b[c-2].count,f=b[c-2].offset,g=d(e,a.count),void(a.offset=f+n(e+g+a.count))):(e=1===c?b[0].count:b[c-2].count,f=1===c?b[0].offset:b[c-2].offset,g=d(e,a.count),void(a.offset=-(-f+n(e+g+a.count))))})}),m.domain([-1,1]);var p=d3.svg.line().x(function(a,b){return b*i}).y(function(a){return m(a)}).interpolate("linear"),q=[[0,0]];a.selectAll(".line").data(q).enter().append("svg:g").append("path").attr("class","line").style("stroke","#555").style("stroke-width","1px").attr("d",p);a.selectAll(".date").data(b).enter().append("svg:g").selectAll(".bubble").data(function(a){return a.artists}).enter().append("circle").attr("class","bubble").attr("r",function(a){return n(a.count)}).attr("cx",function(a){return l(f(a.date))}).attr("cy",function(a){return.5*j+a.offset}).style("fill",function(a){return k(a.artist)}).style("opacity",.7).on("mouseover",function(a){var b=a.artist;d3.selectAll(".bubble").filter(function(a){return a.artist!==b}).transition().style("fill","#444")}).on("mouseout",function(){d3.selectAll(".bubble").transition().style("fill",function(a){return k(a.artist)})}).on("click",function(a){var b=a.artist;e.showArtistCard(b)})},c=function(a,b){$(".overlay").show(),$(".artistInfo").hide(),journey.lastfm.getLastfmTracks(journey.username,a,b,function(a){var b=journey.data.computeDateArtistCounts(a),c=journey.data.normalizeAndSort(b);console.log("normalizedCounts"),console.log(c),journey.artist.clearAllStats(),journey.artist.computeArtistStats(a),journey.aggregate.prepareAggregateStats(),journey.aggregate.updateAggregateStats(),$(".overlay").hide();var d=$(window).width();console.log("about to update!"),$(".musicVis").empty(),journey.vis.dailyBubbles(c,d)})},d=function(a){$(".artistInfo-albums").empty(),$(".artistInfo-tracks").empty(),$(".aggregateInfo").hide(),$(".artistInfo").show(),$(".artistInfo-artistName").text(a);var b=journey.artist.getArtistInfo(a);null!==b&&(b.albums.forEach(function(a){var b=$("<div/>",{"class":"info-album clearfix"}).appendTo(".artistInfo-albums");$("<img>",{src:a.image}).appendTo(b),$("<div/>",{"class":"info-albumName"}).text(a.name).appendTo(b),$("<div/>",{"class":"info-albumCount"}).text(a.count).appendTo(b)}),b.topTracks.slice(0,10).forEach(function(a){var b=$("<div/>",{"class":"info-track clearfix"}).appendTo(".artistInfo-tracks");$("<div/>",{"class":"info-trackName"}).text(a.name).appendTo(b),$("<div/>",{"class":"info-trackCount"}).text(a.count).appendTo(b)}),$(".artistInfo-total span").text(b.total))};return{dailyBubbles:b,updateDailyBubbles:c,showArtistCard:d}}(),journey.timeline=function(){var a=function(a,c,d,e,f){function g(){console.log(q.extent());var a=q.extent();journey.vis.updateDailyBubbles(a[0],a[1]),b(a[0],a[1])}function h(){var a=q.extent();b(a[0],a[1])}console.log(a),console.log(c);var i=32,j={top:12,left:i,right:i,bottom:0},k=d-j.left-j.right,l=50-j.top-j.bottom,m=d3.time.scale().range([0,k]),n=d3.scale.linear().range([l,0]),o=d3.select(".timelineVis").append("svg").attr("width",d).attr("height",l+j.top+j.bottom).append("g").attr("transform","translate("+j.left+","+j.top+")");m.domain([a,c]);var p=d3.svg.axis().scale(m).orient("bottom").tickSize(0);n.domain([0,1]);var q=d3.svg.brush().x(m).on("brush",h).on("brushend",g);q.extent([e,f]),o.append("g").attr("class","timeline").call(p).style("fill","#ddd").style("stroke-width","1px"),o.append("g").attr("class","brush").call(q).selectAll("rect").attr("y",0).attr("height",l).style("fill","#fff").style("fill-opacity",.25).style("shape-rendering","crispEdges")},b=function(a,b){$(".timeTitle span").text(a.toDateString()+" - "+b.toDateString())};return{draw:a,updateTimeTitle:b}}(),journey.aggregate=function(){var a,b,c,d=function(){a=journey.data.getAggregateData();var d=journey.artist.getAllArtistInfo(),e=[];for(var f in d)e.push({name:f,total:d[f].total});e.sort(function(a,b){return b.total-a.total}),console.log(e),b=e.slice(0,20);var g,h=journey.artist.getAllTracksInfo(),i=[];for(var j in h)g=h[j],i.push({name:g.name,album:g.album,artist:g.artist,count:g.count});i.sort(function(a,b){return b.count-a.count}),console.log(i),c=i.slice(0,20)},e=function(){$(".aggregateInfo-total span").text(a.totalPlays),$(".aggregateInfo-average span").text(a.averagePlays.toFixed(2)),$(".aggregateInfo-artists").empty(),$(".aggregateInfo-tracks").empty(),b.forEach(function(a){var b=$("<div/>",{"class":"info-artist clearfix"}).appendTo(".aggregateInfo-artists");$("<div/>",{"class":"info-artistName"}).text(a.name).appendTo(b),$("<div/>",{"class":"info-artistTotal"}).text(a.total).appendTo(b)}),c.forEach(function(a){var b=$("<div/>",{"class":"info-track info-track--withArtist clearfix"}).appendTo(".aggregateInfo-tracks");$("<div/>",{"class":"info-trackName"}).text(a.name).appendTo(b),$("<div/>",{"class":"info-trackCount"}).text(a.count).appendTo(b),$("<div/>",{"class":"info-artistName"}).text(a.artist).appendTo(b)}),$(".aggregateInfo").show()};return{prepareAggregateStats:d,updateAggregateStats:e}}(),$(".start-done").click(function(){if(journey.username=$(".start-lastfm").val(),void 0===journey.username||""===journey.username)return $(".start-error").show(),void $(".start-error").text("Sorry, I see nothing here");$(".start").hide(),$(".overlay").show();var a=new Date,b=new Date;b.setMonth(a.getMonth()-1);var c;journey.lastfm.getLastfmUserInfo(journey.username,function(d){console.log(d),c=new Date(1e3*parseInt(d.user.registered.unixtime));var e=$(window).width();journey.timeline.draw(c,a,e,b,a)}),journey.lastfm.getLastfmTracks(journey.username,b,a,function(c){console.log("here!"),console.log(c);var d=journey.data.computeDateArtistCounts(c);console.log(d);var e=journey.data.normalizeAndSort(d);console.log(e),journey.artist.computeArtistStats(c),journey.artist.printAllStats(),journey.aggregate.prepareAggregateStats(),journey.aggregate.updateAggregateStats(),$(".overlay").hide();var f=$(window).width();journey.vis.dailyBubbles(e,f),$(".timeTitle").show(),journey.timeline.updateTimeTitle(b,a),$(".artistInfo-back").click(function(){$(".artistInfo").hide(),$(".aggregateInfo").show()})})});